<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站连通性检测系统 - 专业版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入html2canvas用于截图 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- 引入FileSaver.js用于文件保存 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* 样式优化，保持原有美观 */
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8f9fa;
            --dark: #1f2937;
            --telegram: #0088cc;
            --itdog: #4f46e5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        /* 头部样式 */
        .app-header {
            background: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .header-left p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
        }
        
        /* 标签页 */
        .tabs {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            position: relative;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab.active {
            color: var(--primary);
            background: white;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f9fafb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .card-title {
            font-size: 1.25rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-telegram {
            background: var(--telegram);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-itdog {
            background: var(--itdog);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        /* 群组卡片 */
        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .group-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            background: white;
            position: relative;
        }
        
        .group-card.active {
            border-color: var(--telegram);
            background: linear-gradient(to right, rgba(0, 136, 204, 0.05), transparent);
        }
        
        .group-card.testing {
            border-color: var(--info);
            background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);
        }
        
        .group-card.low-connectivity {
            border-color: var(--danger);
            background: linear-gradient(to right, rgba(239, 68, 68, 0.05), transparent);
        }
        
        .group-card.good-connectivity {
            border-color: var(--success);
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .group-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-website {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            word-break: break-all;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }
        
        .group-bind-info {
            background: linear-gradient(135deg, #f0f4ff, #e6f7ff);
            border: 1px solid #d1e9ff;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .group-bind-info strong {
            color: var(--telegram);
        }
        
        /* 内嵌浏览器 */
        .browser-container {
            width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            display: none;
            flex-direction: column;
            max-height: 700px;
        }
        
        .browser-container.active {
            display: flex;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 700px;
            }
        }
        
        .browser-header {
            background: var(--light);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .browser-url {
            flex: 1;
            padding: 6px 12px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
        }
        
        .browser-frame {
            width: 100%;
            height: 600px;
            border: none;
            background: white;
            flex: 1;
        }
        
        /* 检测结果展示 */
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e5e7eb;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-location {
            font-weight: 600;
            color: var(--dark);
        }
        
        .result-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .connectivity-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .connectivity-high {
            background: #d1fae5;
            color: #065f46;
        }
        
        .connectivity-medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .connectivity-low {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* 批量检测控制 */
        .batch-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        /* 链接输入区 */
        .batch-links-input {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            margin-top: 10px;
        }
        
        .batch-links-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* 状态标签 */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-testing { background: #dbeafe; color: #1d4ed8; }
        .status-success { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .status-low { background: #fee2e2; color: #991b1b; }
        .status-good { background: #d1fae5; color: #065f46; }
        
        /* 检测进度 */
        .detection-progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e5e7eb;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            position: relative;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }
        
        .step-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .step-dot.active {
            background: var(--primary);
            color: white;
        }
        
        .step-dot.completed {
            background: var(--success);
            color: white;
        }
        
        .step-label {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }
        
        .progress-line {
            position: absolute;
            top: 15px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }
        
        /* 链接列表 */
        .links-container {
            margin: 15px 0;
        }
        
        .link-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .link-item.testing {
            background: #dbeafe;
            border-color: var(--info);
        }
        
        .link-item.completed {
            background: #d1fae5;
            border-color: var(--success);
        }
        
        .link-item.error {
            background: #fee2e2;
            border-color: var(--danger);
        }
        
        .link-text {
            flex: 1;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        /* 检测结果 */
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            background: white;
        }
        
        .result-card.success {
            border-color: var(--success);
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
        }
        
        .result-card.error {
            border-color: var(--danger);
            background: linear-gradient(to right, rgba(239, 68, 68, 0.05), transparent);
        }
        
        .result-card.warning {
            border-color: var(--warning);
            background: linear-gradient(to right, rgba(245, 158, 11, 0.05), transparent);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* 导入导出区域 */
        .import-export-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #e5e7eb;
            margin: 20px 0;
        }
        
        .import-export-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            flex: 1;
            min-width: 200px;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-btn {
            display: inline-block;
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .file-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* 实时状态显示 */
        .real-time-status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            margin: 15px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        /* 日志显示 */
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-time {
            color: #9ca3af;
            margin-right: 10px;
        }
        
        .log-info { color: #3b82f6; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        .log-error { color: #ef4444; }
        
        /* 步骤指示器 */
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
        }
        
        .step-indicator.active {
            background: #e8f4ff;
            border-left-color: var(--info);
        }
        
        .step-indicator.completed {
            background: #f0fff4;
            border-left-color: var(--success);
        }
        
        .step-indicator i {
            width: 20px;
        }
        
        /* 浏览器加载指示器 */
        .browser-loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .browser-loading.active {
            display: block;
        }
        
        .browser-frame-wrapper {
            position: relative;
            height: 600px;
        }
        
        /* 结果预览 */
        .result-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        /* 模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--info);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 连通性图表 */
        .connectivity-chart {
            height: 60px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        
        .connectivity-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.5s ease;
        }
        
        .connectivity-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            color: var(--dark);
        }
        
        /* 工具类 */
        .mt-10 { margin-top: 10px; }
        .mt-15 { margin-top: 15px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .py-20 { padding: 20px 0; }
        .py-40 { padding: 40px 0; }
        .text-center { text-align: center; }
        .text-muted { color: #666; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-10 { gap: 10px; }
        
        /* 页脚 */
        .app-footer {
            padding: 15px 30px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            color: #666;
            font-size: 0.85rem;
            background: white;
        }
        
        /* 大图预览模态框 */
        .image-preview-modal .modal {
            max-width: 90%;
        }
        
        .image-preview-modal img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* 检测结果表格样式 */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .result-table th {
            background: #f3f4f6;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #e5e7eb;
        }
        
        .result-table td {
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
        }
        
        .result-table .fastest {
            background: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        
        .result-table .slowest {
            background: #fee2e2;
            color: #991b1b;
            font-weight: 600;
        }
        
        /* 地图样式 */
        .china-map {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .region {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
        }
        
        .region h4 {
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 16px;
        }
        
        /* 检测状态面板 */
        .detection-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e5e7eb;
        }
        
        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* 进度条 */
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }
        
        /* 绑定状态指示器 */
        .bind-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .bind-status.bound {
            background: #d1fae5;
            color: #065f46;
        }
        
        .bind-status.unbound {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* 检测控制按钮 */
        .detection-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="header-left">
                <h1><i class="fas fa-globe"></i> 网站连通性检测系统 - 专业版</h1>
                <p>使用itdog.cn进行网站连通性检测 - 大陆地区专线测试</p>
            </div>
            <div class="header-right">
                <button class="btn btn-telegram" onclick="openBotConfig()">
                    <i class="fas fa-robot"></i> 机器人配置
                </button>
                <button class="btn btn-success" onclick="startBatchDetection()">
                    <i class="fas fa-play"></i> 开始批量检测
                </button>
                <button class="btn btn-danger" onclick="stopAllDetection()">
                    <i class="fas fa-stop"></i> 停止所有
                </button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('groups')"><i class="fas fa-users"></i> 群组管理</button>
            <button class="tab" onclick="switchTab('detection')"><i class="fas fa-search"></i> 批量网站检测</button>
            <button class="tab" onclick="switchTab('automation')"><i class="fas fa-robot"></i> 自动化检测</button>
            <button class="tab" onclick="switchTab('results')"><i class="fas fa-chart-bar"></i> 检测结果</button>
        </div>
        
        <div class="main-content">
            <!-- 群组管理标签页 -->
            <div id="tab-groups" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-users"></i> 群组配置管理</h3>
                        <div class="d-flex gap-10">
                            <button class="btn btn-primary" onclick="openAddGroupModal()">
                                <i class="fas fa-plus"></i> 添加新群组
                            </button>
                            <button class="btn btn-info" onclick="exportGroupsToFile()">
                                <i class="fas fa-download"></i> 导出配置
                            </button>
                        </div>
                    </div>
                    
                    <div class="import-export-area" style="margin-top: 20px;" id="importArea">
                        <h4><i class="fas fa-file-import"></i> 导入群组配置</h4>
                        <p class="text-muted mb-10">支持JSON格式的群组配置文件</p>
                        <div class="import-export-controls">
                            <div class="file-input-wrapper">
                                <button class="file-input-btn">
                                    <i class="fas fa-upload"></i> 选择JSON文件
                                </button>
                                <input type="file" id="importFile" accept=".json" onchange="importGroupsFromFile(this)">
                            </div>
                            <button class="btn btn-secondary" onclick="loadExampleGroups()">
                                <i class="fas fa-file-alt"></i> 加载示例配置
                            </button>
                            <button class="btn btn-danger" onclick="clearAllGroups()">
                                <i class="fas fa-trash"></i> 清空所有
                            </button>
                        </div>
                        <div id="importPreview" class="result-preview" style="display: none;"></div>
                    </div>
                    
                    <div class="groups-container" id="groupsContainer">
                        <!-- 群组卡片会动态添加到这里 -->
                    </div>
                </div>
            </div>
            
            <!-- 批量网站检测标签页 -->
            <div id="tab-detection" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-globe"></i> 批量网站连通性检测</h3>
                        <div class="d-flex gap-10">
                            <button class="btn btn-success" onclick="startMultiCheck()">
                                <i class="fas fa-play"></i> 开始检测
                            </button>
                            <button class="btn btn-danger" onclick="stopAllChecks()" id="stopBtn">
                                <i class="fas fa-stop"></i> 停止
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group mb-20">
                        <label class="form-label">
                            <i class="fas fa-list"></i> 批量输入待检测网站（每行一个网站，支持域名或完整URL）
                        </label>
                        <textarea id="batchLinksInput" class="batch-links-input" placeholder="示例网站：
example.com
https://example.com
test.com/path
api.example.com
subdomain.test.com

# 系统将使用itdog.cn进行大陆地区连通性测试
# 每行一个网站，自动去除协议头"></textarea>
                        <div class="d-flex justify-between mt-10">
                            <button class="btn btn-sm btn-warning" onclick="loadExampleWebsites()">
                                <i class="fas fa-file-alt"></i> 加载示例
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="analyzeWebsites()">
                                <i class="fas fa-cogs"></i> 解析网站
                            </button>
                        </div>
                    </div>
                    
                    <div class="real-time-status">
                        <div id="currentStep" class="step-indicator">
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <span>等待开始...</span>
                        </div>
                        <div class="status-item">
                            <span>待检测网站:</span>
                            <span id="pendingCount">0</span>
                        </div>
                        <div class="status-item">
                            <span>正在检测:</span>
                            <span id="currentWebsite">无</span>
                        </div>
                        <div class="status-item">
                            <span>检测进度:</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="status-item">
                            <span>当前连通率:</span>
                            <span id="currentConnectivity">0%</span>
                        </div>
                    </div>
                    
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">[系统]</span>
                            <span class="log-info">系统已就绪，等待开始检测...</span>
                        </div>
                    </div>
                    
                    <div id="detectionQueue" class="links-container">
                        <!-- 检测队列会动态显示 -->
                        <div class="text-center text-muted py-20">等待解析网站...</div>
                    </div>
                </div>
            </div>
            
            <!-- 自动化检测标签页 -->
            <div id="tab-automation" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-robot"></i> 自动化网站检测（基于itdog.cn）</h3>
                        <span class="status-badge status-testing" id="autoStatus">自动检测</span>
                    </div>
                    
                    <div class="batch-controls">
                        <div class="form-group">
                            <label class="form-label">自动化模式</label>
                            <select id="autoMode" class="form-input">
                                <option value="single">单次检测</option>
                                <option value="interval" selected>定时检测</option>
                                <option value="continuous">连续检测</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">检测间隔</label>
                            <select id="autoInterval" class="form-input">
                                <option value="5">5分钟</option>
                                <option value="15">15分钟</option>
                                <option value="30" selected>30分钟</option>
                                <option value="60">1小时</option>
                                <option value="120">2小时</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">增强功能设置</label>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label>
                                    <input type="checkbox" id="useScreenshot" checked> 自动截图检测结果
                                </label>
                                <label>
                                    <input type="checkbox" id="sendToTelegram" checked> 自动发送到Telegram
                                </label>
                                <label>
                                    <input type="checkbox" id="alertLowConnectivity" checked> 连通率低于90%时@相关人员
                                </label>
                                <label>
                                    <input type="checkbox" id="onlyMainland" checked> 仅检测中国大陆地区
                                </label>
                                <label>
                                    <input type="checkbox" id="sequentialDetection" checked> 顺序检测（完成一个再下一个）
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detection-controls">
                        <button class="btn btn-itdog" onclick="testItdogDetection()">
                            <i class="fas fa-play-circle"></i> 测试itdog.cn检测
                        </button>
                        <button class="btn btn-warning" onclick="testSingleGroupAutomation()">
                            <i class="fas fa-vial"></i> 测试单个群组自动化
                        </button>
                        <button class="btn btn-info" onclick="startAllGroupsAutomation()">
                            <i class="fas fa-robot"></i> 启动所有群组自动化
                        </button>
                    </div>
                    
                    <div class="real-time-status mt-20">
                        <h4><i class="fas fa-tasks"></i> 自动化检测进度</h4>
                        <div id="autoStep1" class="step-indicator">
                            <i class="fas fa-circle"></i>
                            <span>准备检测网站</span>
                        </div>
                        <div id="autoStep2" class="step-indicator">
                            <i class="fas fa-circle"></i>
                            <span>打开itdog.cn</span>
                        </div>
                        <div id="autoStep3" class="step-indicator">
                            <i class="fas fa-circle"></i>
                            <span>执行连通性测试</span>
                        </div>
                        <div id="autoStep4" class="step-indicator">
                            <i class="fas fa-circle"></i>
                            <span>分析检测结果</span>
                        </div>
                        <div id="autoStep5" class="step-indicator">
                            <i class="fas fa-circle"></i>
                            <span>发送检测报告</span>
                        </div>
                    </div>
                    
                    <div class="mt-20">
                        <h4><i class="fas fa-desktop"></i> 内嵌浏览器 - itdog.cn</h4>
                        <div class="browser-container active" id="globalBrowser">
                            <div class="browser-header">
                                <i class="fas fa-globe"></i>
                                <input type="text" class="browser-url" id="globalBrowserUrl" value="https://www.itdog.cn" readonly>
                                <span class="status-badge status-pending" id="globalBrowserStatus">准备中</span>
                                <div class="d-flex gap-10">
                                    <button class="btn btn-sm btn-success" onclick="openItdogHome()">
                                        <i class="fas fa-home"></i> 首页
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="testCurrentSite()">
                                        <i class="fas fa-wifi"></i> 测试当前站点
                                    </button>
                                    <button class="btn btn-sm btn-itdog" onclick="clickSingleTest()">
                                        <i class="fas fa-play"></i> 点击单次测试
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="closeGlobalBrowser()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="browser-frame-wrapper">
                                <div class="browser-loading" id="browserLoading">
                                    <div class="spinner"></div>
                                    <p>正在加载itdog.cn...</p>
                                </div>
                                <iframe class="browser-frame" id="globalBrowserFrame" 
                                        src="https://www.itdog.cn"
                                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms">
                                </iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 检测结果标签页 -->
            <div id="tab-results" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDetected">0</div>
                        <div class="stat-label">总检测次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="goodConnectivity">0</div>
                        <div class="stat-label">良好连通性(≥90%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowConnectivity">0</div>
                        <div class="stat-label">低连通性(<90%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sentCount">0</div>
                        <div class="stat-label">报告已发送</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> 最近检测结果</h3>
                        <div class="d-flex gap-10">
                            <button class="btn btn-sm btn-secondary" onclick="filterResults('all')">全部</button>
                            <button class="btn btn-sm btn-success" onclick="filterResults('good')">良好</button>
                            <button class="btn btn-sm btn-danger" onclick="filterResults('low')">低连通</button>
                            <button class="btn btn-sm btn-warning" onclick="filterResults('failed')">失败</button>
                            <button class="btn btn-sm btn-telegram" onclick="filterResults('sent')">已发送</button>
                        </div>
                    </div>
                    
                    <div class="results-container" id="resultsContainer">
                        <!-- 结果卡片会动态添加 -->
                        <div class="text-center text-muted py-40" style="grid-column: 1 / -1;">
                            <i class="fas fa-search fa-3x mb-15"></i>
                            <p>暂无检测结果</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 添加群组模态框 -->
        <div class="modal-overlay" id="groupModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">配置群组检测规则</h3>
                    <button class="btn btn-sm btn-danger" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">群组名称</label>
                    <input type="text" id="groupName" class="form-input" placeholder="例如：运维监控群">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telegram群组ID</label>
                    <input type="text" id="chatId" class="form-input" placeholder="-1001234567890 (数字ID)">
                    <small class="text-muted">必须是数字格式的群组ID</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">@相关人员（可选）</label>
                    <input type="text" id="mentions" class="form-input" placeholder="@username1 @username2">
                    <small class="text-muted">当连通率低于90%时，会@这些人（用空格分隔）</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">检测网站（多个用换行分隔）</label>
                    <textarea id="websiteList" class="form-input" rows="4" placeholder="example.com
api.example.com
test.com/path
subdomain.test.com"></textarea>
                    <small class="text-muted">每行一个网站，支持域名或路径</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">检测设置</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label>
                            <input type="checkbox" id="onlyMainlandCheck" checked> 仅检测中国大陆地区
                        </label>
                        <label>
                            <input type="checkbox" id="autoSendReport" checked> 自动发送检测报告
                        </label>
                        <label>
                            <input type="checkbox" id="alertThreshold" checked> 连通率低于90%时@相关人员
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">检测间隔（分钟）</label>
                    <select id="checkInterval" class="form-input">
                        <option value="5">5分钟</option>
                        <option value="15">15分钟</option>
                        <option value="30" selected>30分钟</option>
                        <option value="60">1小时</option>
                        <option value="120">2小时</option>
                        <option value="360">6小时</option>
                        <option value="720">12小时</option>
                        <option value="1440">24小时</option>
                    </select>
                </div>
                
                <div class="d-flex gap-10 mt-20">
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveGroup()">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                    <button class="btn btn-danger" onclick="closeModal()">
                        取消
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 机器人配置模态框 -->
        <div class="modal-overlay" id="botConfigModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-robot"></i> Telegram机器人配置</h3>
                    <button class="btn btn-sm btn-danger" onclick="closeBotConfig()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Bot Token</label>
                    <input type="text" id="botToken" class="form-input" placeholder="1234567890:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw">
                    <small class="text-muted">从 @BotFather 获取的机器人Token</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">消息格式</label>
                    <select id="messageFormat" class="form-input">
                        <option value="markdown" selected>Markdown格式</option>
                        <option value="html">HTML格式</option>
                        <option value="text">纯文本</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">检测报告设置</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label>
                            <input type="checkbox" id="sendScreenshot" checked> 发送检测结果截图
                        </label>
                        <label>
                            <input type="checkbox" id="sendSummary" checked> 发送详细汇总报告
                        </label>
                        <label>
                            <input type="checkbox" id="includeChart" checked> 包含连通性图表
                        </label>
                        <label>
                            <input type="checkbox" id="testConnection" checked> 测试时发送示例报告
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">测试机器人连接</label>
                    <div class="d-flex gap-10">
                        <button class="btn btn-sm btn-telegram" onclick="testBotConnection()">
                            <i class="fas fa-wifi"></i> 测试连接
                        </button>
                        <button class="btn btn-sm btn-success" onclick="sendTestReport()">
                            <i class="fas fa-paper-plane"></i> 发送测试报告
                        </button>
                    </div>
                    <div id="botTestResult" class="mt-10"></div>
                </div>
                
                <div class="d-flex gap-10 mt-20">
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveBotConfig()">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                    <button class="btn btn-danger" onclick="closeBotConfig()">
                        取消
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 检测结果详情模态框 -->
        <div class="modal-overlay" id="resultDetailModal">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-chart-line"></i> 检测结果详情</h3>
                    <button class="btn btn-sm btn-danger" onclick="closeResultDetail()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="resultDetailContent">
                    <!-- 结果详情将在这里显示 -->
                </div>
            </div>
        </div>
        
        <!-- 图片预览模态框 -->
        <div class="modal-overlay image-preview-modal" id="imagePreviewModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-image"></i> 检测结果截图预览</h3>
                    <button class="btn btn-sm btn-danger" onclick="closeImagePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="text-align: center;">
                    <img id="previewImage" src="" alt="检测结果截图">
                </div>
                <div class="d-flex gap-10 mt-20">
                    <button class="btn btn-primary" onclick="downloadScreenshot()">
                        <i class="fas fa-download"></i> 下载截图
                    </button>
                    <button class="btn btn-telegram" onclick="resendToTelegram()">
                        <i class="fab fa-telegram"></i> 重新发送
                    </button>
                </div>
            </div>
        </div>
        
        <div class="app-footer">
            <p>© 2024 网站连通性检测系统 - 专业版 | 基于itdog.cn的大陆地区连通性测试</p>
        </div>
    </div>

    <script>
        // ==============================
        // 全局变量和配置
        // ==============================
        let telegramGroups = [];
        let detectionQueue = [];
        let checkResults = [];
        let isChecking = false;
        let isAutoDetecting = false;
        let autoDetectionTimers = {};
        let currentDetectionIndex = 0;
        let isBatchRunning = false;
        
        // 机器人配置
        let botConfig = {
            token: '',
            apiServer: 'https://api.telegram.org',
            messageFormat: 'markdown',
            sendScreenshot: true,
            sendSummary: true,
            includeChart: true,
            testConnection: true,
            connected: false
        };
        
        // 统计数据
        const stats = {
            totalDetected: 0,
            goodConnectivity: 0,
            lowConnectivity: 0,
            sentCount: 0,
            failedCount: 0
        };
        
        // 当前检测的网站
        let currentDetectingGroup = null;
        let currentDetectingWebsite = null;
        let currentDetectionResult = null;

        // ==============================
        // 基础工具函数
        // ==============================

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            const tabs = document.querySelectorAll('.tab');
            const tabNames = ['groups', 'detection', 'automation', 'results'];
            const tabIndex = tabNames.indexOf(tabName);
            if (tabIndex !== -1 && tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }
        }

        // 等待函数
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 保存所有数据到本地存储
        function saveAllData() {
            try {
                localStorage.setItem('telegramGroups', JSON.stringify(telegramGroups));
                localStorage.setItem('checkResults', JSON.stringify(checkResults.slice(0, 100)));
                localStorage.setItem('detectionStats', JSON.stringify(stats));
                localStorage.setItem('botConfig', JSON.stringify(botConfig));
            } catch (e) {
                console.error('保存数据失败:', e);
            }
        }

        // 加载所有数据
        function loadAllData() {
            try {
                const savedGroups = localStorage.getItem('telegramGroups');
                if (savedGroups) {
                    telegramGroups = JSON.parse(savedGroups);
                    updateGroupsDisplay();
                }
                
                const savedResults = localStorage.getItem('checkResults');
                if (savedResults) {
                    checkResults = JSON.parse(savedResults);
                    updateResultsDisplay();
                }
                
                const savedStats = localStorage.getItem('detectionStats');
                if (savedStats) {
                    Object.assign(stats, JSON.parse(savedStats));
                    updateStatsDisplay();
                }
                
                const savedBotConfig = localStorage.getItem('botConfig');
                if (savedBotConfig) {
                    botConfig = JSON.parse(savedBotConfig);
                }
            } catch (e) {
                console.error('加载数据失败:', e);
                showNotification('加载数据失败，请检查浏览器存储', 'error');
            }
        }

        // ==============================
        // 群组管理函数
        // ==============================

        // 打开添加群组模态框
        function openAddGroupModal() {
            document.getElementById('modalTitle').textContent = '添加新群组';
            document.getElementById('groupName').value = '';
            document.getElementById('chatId').value = '';
            document.getElementById('mentions').value = '';
            document.getElementById('websiteList').value = '';
            document.getElementById('onlyMainlandCheck').checked = true;
            document.getElementById('autoSendReport').checked = true;
            document.getElementById('alertThreshold').checked = true;
            document.getElementById('checkInterval').value = '30';
            
            currentDetectingGroup = null;
            document.getElementById('groupModal').classList.add('active');
        }

        // 编辑群组
        function editGroup(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (!group) return;
            
            document.getElementById('modalTitle').textContent = '编辑群组';
            document.getElementById('groupName').value = group.name;
            document.getElementById('chatId').value = group.chatId;
            document.getElementById('mentions').value = group.mentions || '';
            document.getElementById('websiteList').value = group.websites ? group.websites.join('\n') : '';
            document.getElementById('onlyMainlandCheck').checked = group.onlyMainland !== false;
            document.getElementById('autoSendReport').checked = group.autoSendReport !== false;
            document.getElementById('alertThreshold').checked = group.alertThreshold !== false;
            document.getElementById('checkInterval').value = group.checkInterval || '30';
            
            currentDetectingGroup = group;
            
            document.getElementById('groupModal').classList.add('active');
        }

        // 保存群组
        function saveGroup() {
            const name = document.getElementById('groupName').value.trim();
            const chatId = document.getElementById('chatId').value.trim();
            const mentions = document.getElementById('mentions').value.trim();
            const websiteList = document.getElementById('websiteList').value.trim();
            const onlyMainland = document.getElementById('onlyMainlandCheck').checked;
            const autoSendReport = document.getElementById('autoSendReport').checked;
            const alertThreshold = document.getElementById('alertThreshold').checked;
            const checkInterval = parseInt(document.getElementById('checkInterval').value);
            
            if (!name || !chatId) {
                showNotification('请填写群组名称和ID', 'error');
                return;
            }
            
            const websites = websiteList.split('\n')
                .map(w => w.trim())
                .filter(w => w.length > 0)
                .map(w => {
                    // 去除协议头，只保留域名和路径
                    return w.replace(/^https?:\/\//, '').replace(/^www\./, '');
                });
            
            if (websites.length === 0) {
                showNotification('请至少添加一个检测网站', 'error');
                return;
            }
            
            if (currentDetectingGroup) {
                // 编辑现有群组
                currentDetectingGroup.name = name;
                currentDetectingGroup.chatId = chatId;
                currentDetectingGroup.mentions = mentions;
                currentDetectingGroup.websites = websites;
                currentDetectingGroup.onlyMainland = onlyMainland;
                currentDetectingGroup.autoSendReport = autoSendReport;
                currentDetectingGroup.alertThreshold = alertThreshold;
                currentDetectingGroup.checkInterval = checkInterval;
                
                showNotification('群组已更新', 'success');
                addLog(`更新群组: ${name}`, 'info');
            } else {
                // 添加新群组
                const newGroup = {
                    id: 'group_' + Date.now() + Math.random().toString(36).substr(2, 9),
                    name,
                    chatId,
                    mentions,
                    websites,
                    onlyMainland,
                    autoSendReport,
                    alertThreshold,
                    checkInterval,
                    isActive: true,
                    status: 'pending',
                    detectionCount: 0,
                    lowConnectivityCount: 0,
                    lastDetected: null,
                    lastResult: null,
                    logs: [],
                    isBound: true,
                    botToken: botConfig.token
                };
                
                telegramGroups.push(newGroup);
                showNotification('群组已添加并绑定', 'success');
                addLog(`添加群组: ${name}`, 'info');
            }
            
            saveAllData();
            updateGroupsDisplay();
            closeModal();
        }

        // 删除群组
        function deleteGroup(groupId) {
            if (confirm('确定要删除这个群组吗？')) {
                telegramGroups = telegramGroups.filter(g => g.id !== groupId);
                saveAllData();
                updateGroupsDisplay();
                showNotification('群组已删除', 'success');
                addLog('删除群组', 'info');
            }
        }

        // 切换群组激活状态
        function toggleGroupActive(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (group) {
                group.isActive = !group.isActive;
                
                if (!group.isActive && autoDetectionTimers[groupId]) {
                    clearInterval(autoDetectionTimers[groupId]);
                    delete autoDetectionTimers[groupId];
                }
                
                saveAllData();
                updateGroupsDisplay();
                showNotification(`群组已${group.isActive ? '激活' : '停用'}`, 'info');
                addLog(`${group.isActive ? '激活' : '停用'}群组: ${group.name}`, 'info');
            }
        }

        // 手动检测群组
        function manuallyTestGroup(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (!group) return;
            
            startGroupDetection(groupId);
        }

        // 加载示例群组
        function loadExampleGroups() {
            telegramGroups = [
                {
                    id: 'group_1_' + Date.now(),
                    name: '重要业务监控',
                    chatId: '-1001234567890',
                    mentions: '@admin @devops',
                    websites: ['example.com', 'api.example.com', 'cdn.example.com'],
                    onlyMainland: true,
                    autoSendReport: true,
                    alertThreshold: true,
                    checkInterval: 30,
                    isActive: true,
                    status: 'pending',
                    detectionCount: 0,
                    lowConnectivityCount: 0,
                    lastDetected: null,
                    lastResult: null,
                    logs: [],
                    isBound: true,
                    botToken: botConfig.token || '未配置'
                },
                {
                    id: 'group_2_' + Date.now(),
                    name: '测试环境监控',
                    chatId: '-1009876543210',
                    mentions: '@tester @developer',
                    websites: ['test.com', 'staging.example.com'],
                    onlyMainland: true,
                    autoSendReport: true,
                    alertThreshold: false,
                    checkInterval: 60,
                    isActive: true,
                    status: 'pending',
                    detectionCount: 0,
                    lowConnectivityCount: 0,
                    lastDetected: null,
                    lastResult: null,
                    logs: [],
                    isBound: true,
                    botToken: botConfig.token || '未配置'
                }
            ];
            updateGroupsDisplay();
            saveAllData();
            showNotification('示例群组已加载完成', 'info');
            addLog('示例群组已加载', 'info');
        }

        // 更新群组显示
        function updateGroupsDisplay() {
            const container = document.getElementById('groupsContainer');
            if (!container) {
                console.error('找不到groupsContainer元素');
                return;
            }
            
            if (telegramGroups.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-40">
                        <i class="fas fa-users fa-3x mb-15"></i>
                        <p>暂无配置的群组，请添加第一个群组</p>
                        <button class="btn btn-primary mt-10" onclick="openAddGroupModal()">
                            <i class="fas fa-plus"></i> 添加群组
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            telegramGroups.forEach(group => {
                const isTesting = group.status === 'testing';
                const isAutoDetecting = autoDetectionTimers[group.id];
                const lastResult = group.lastResult;
                const connectivity = lastResult ? lastResult.connectivity : null;
                const isLowConnectivity = connectivity !== null && connectivity < 90;
                
                let cardClass = 'group-card';
                if (isTesting) cardClass += ' testing';
                else if (isLowConnectivity) cardClass += ' low-connectivity';
                else if (connectivity !== null && connectivity >= 90) cardClass += ' good-connectivity';
                else if (group.isActive) cardClass += ' active';
                
                // 检查绑定状态
                const isBound = group.isBound && group.botToken === botConfig.token;
                
                html += `
                    <div class="${cardClass}" id="group-${group.id}">
                        <div class="group-header">
                            <div class="group-name">
                                <i class="fab fa-telegram"></i> ${group.name}
                                ${isAutoDetecting ? '<i class="fas fa-robot text-info ml-1"></i>' : ''}
                                ${isTesting ? '<i class="fas fa-sync-alt fa-spin text-info ml-1"></i>' : ''}
                                ${isLowConnectivity ? '<i class="fas fa-exclamation-triangle text-danger ml-1"></i>' : ''}
                                <span class="bind-status ${isBound ? 'bound' : 'unbound'}">
                                    <i class="fas ${isBound ? 'fa-link' : 'fa-unlink'}"></i>
                                    ${isBound ? '已绑定' : '未绑定'}
                                </span>
                            </div>
                            <div class="d-flex gap-10">
                                <button class="btn btn-sm btn-warning" onclick="toggleGroupActive('${group.id}')">
                                    <i class="fas ${group.isActive ? 'fa-pause' : 'fa-play'}"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editGroup('${group.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGroup('${group.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="group-bind-info">
                            <strong><i class="fab fa-telegram"></i> 绑定信息：</strong>
                            <div>群组ID: ${group.chatId}</div>
                            ${group.mentions ? `<div>@通知: ${group.mentions}</div>` : ''}
                            <div>机器人状态: ${isBound ? '已连接' : '未连接'}</div>
                        </div>
                        
                        <div class="group-website">
                            <i class="fas fa-globe"></i> ${group.websites.length}个检测网站
                        </div>
                        
                        <div class="mt-15">
                            <div class="d-flex justify-between text-muted mb-5">
                                <small>检测间隔: ${group.checkInterval}分钟</small>
                                <small>检测次数: ${group.detectionCount || 0}</small>
                                <small>低连通次数: ${group.lowConnectivityCount || 0}</small>
                            </div>
                            <div class="d-flex justify-between align-center">
                                <span class="status-badge status-${group.status || 'pending'}">
                                    ${getGroupStatusText(group.status)}
                                </span>
                                ${connectivity !== null ? `
                                    <span class="connectivity-badge ${connectivity >= 90 ? 'connectivity-high' : connectivity >= 70 ? 'connectivity-medium' : 'connectivity-low'}">
                                        ${connectivity}% 连通
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="mt-15 d-flex gap-10">
                            <button class="btn btn-sm btn-success" onclick="manuallyTestGroup('${group.id}')" style="flex: 1;">
                                <i class="fas fa-play"></i> 手动检测
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewGroupResults('${group.id}')" style="flex: 1;">
                                <i class="fas fa-chart-bar"></i> 查看结果
                            </button>
                            <button class="btn btn-sm btn-itdog" onclick="testGroupOnItdog('${group.id}')" style="flex: 1;">
                                <i class="fas fa-wifi"></i> itdog测试
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getGroupStatusText(status) {
            const statusMap = {
                'pending': '等待',
                'testing': '检测中',
                'completed': '已完成',
                'error': '错误',
                'low': '低连通',
                'good': '良好'
            };
            return statusMap[status] || status || '等待';
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('groupModal').classList.remove('active');
            currentDetectingGroup = null;
        }

        // ==============================
        // itdog.cn 检测功能
        // ==============================

        // 打开itdog首页
        function openItdogHome() {
            const browserFrame = document.getElementById('globalBrowserFrame');
            const browserLoading = document.getElementById('browserLoading');
            const browserStatus = document.getElementById('globalBrowserStatus');
            const browserUrl = document.getElementById('globalBrowserUrl');
            
            browserLoading.classList.add('active');
            browserStatus.className = 'status-badge status-testing';
            browserStatus.textContent = '加载中';
            browserUrl.value = 'https://www.itdog.cn';
            
            browserFrame.src = 'https://www.itdog.cn';
            
            showNotification('正在打开itdog.cn首页', 'info');
            addLog('打开itdog.cn首页', 'info');
        }

        // 点击单次测试按钮
        async function clickSingleTest() {
            const browserFrame = document.getElementById('globalBrowserFrame');
            if (!browserFrame || !browserFrame.contentWindow) {
                showNotification('浏览器未加载完成', 'warning');
                return;
            }
            
            try {
                // 等待页面加载
                await sleep(2000);
                
                // 尝试点击单次测试按钮
                const script = `
                    try {
                        // 查找单次测试按钮
                        const singleTestBtn = Array.from(document.querySelectorAll('button')).find(btn => 
                            btn.textContent.includes('单次测试') || 
                            btn.textContent.includes('单次检测') ||
                            (btn.textContent.trim() === '单次')
                        );
                        
                        if (singleTestBtn) {
                            singleTestBtn.click();
                            console.log('已点击单次测试按钮');
                            return true;
                        }
                        
                        // 如果找不到，尝试点击包含"测试"的按钮
                        const testBtns = Array.from(document.querySelectorAll('button')).filter(btn => 
                            btn.textContent.includes('测试')
                        );
                        
                        if (testBtns.length > 0) {
                            testBtns[0].click();
                            console.log('已点击测试按钮');
                            return true;
                        }
                        
                        // 如果还找不到，点击第一个按钮
                        const firstBtn = document.querySelector('button');
                        if (firstBtn) {
                            firstBtn.click();
                            console.log('已点击第一个按钮');
                            return true;
                        }
                        
                        return false;
                    } catch (e) {
                        console.error('点击按钮失败:', e);
                        return false;
                    }
                `;
                
                const result = await executeScriptInIframe(browserFrame, script);
                
                if (result) {
                    showNotification('已点击单次测试按钮', 'success');
                    addLog('已点击itdog单次测试按钮', 'info');
                } else {
                    showNotification('未找到单次测试按钮，请手动点击', 'warning');
                    addLog('未找到单次测试按钮', 'warning');
                }
            } catch (error) {
                console.error('点击单次测试失败:', error);
                showNotification('操作失败: ' + error.message, 'error');
                addLog('点击单次测试失败: ' + error.message, 'error');
            }
        }

        // 在itdog上测试网站
        async function testWebsiteOnItdog(website, onlyMainland = true) {
            try {
                const browserFrame = document.getElementById('globalBrowserFrame');
                const browserLoading = document.getElementById('browserLoading');
                const browserStatus = document.getElementById('globalBrowserStatus');
                const browserUrl = document.getElementById('globalBrowserUrl');
                
                browserLoading.classList.add('active');
                browserStatus.className = 'status-badge status-testing';
                browserStatus.textContent = '检测中';
                
                // 1. 打开itdog.cn的ping测试页面
                let itdogUrl = `https://www.itdog.cn/ping/${encodeURIComponent(website)}`;
                browserUrl.value = itdogUrl;
                browserFrame.src = itdogUrl;
                
                // 等待页面加载
                await sleep(3000);
                
                // 2. 取消勾选港澳台、海外
                if (onlyMainland) {
                    await uncheckOverseasNodes(browserFrame);
                    await sleep(1000);
                }
                
                // 3. 点击单次测试按钮
                await clickSingleTest();
                await sleep(2000);
                
                // 4. 等待检测完成（约15秒）
                for (let i = 0; i < 15; i++) {
                    browserStatus.textContent = `检测中 ${i+1}/15秒`;
                    await sleep(1000);
                }
                
                // 5. 获取检测结果截图
                const screenshot = await captureItdogResult(website);
                
                // 6. 分析检测结果
                const result = await analyzeItdogResults(website, screenshot);
                
                browserLoading.classList.remove('active');
                browserStatus.className = 'status-badge status-success';
                browserStatus.textContent = '检测完成';
                
                showNotification(`检测完成: ${website}`, 'success');
                addLog(`itdog检测完成: ${website}`, 'success');
                
                return {
                    screenshot: screenshot,
                    result: result
                };
                
            } catch (error) {
                console.error('测试网站失败:', error);
                showNotification(`检测失败: ${error.message}`, 'error');
                addLog(`检测失败: ${error.message}`, 'error');
                
                document.getElementById('browserLoading').classList.remove('active');
                document.getElementById('globalBrowserStatus').textContent = '检测失败';
                
                return null;
            }
        }

        // 取消勾选港澳台、海外
        async function uncheckOverseasNodes(browserFrame) {
            try {
                const script = `
                    try {
                        // 查找包含"港澳台"或"海外"的复选框
                        const checkboxes = Array.from(document.querySelectorAll('input[type="checkbox"]'));
                        const overseasCheckboxes = checkboxes.filter(cb => {
                            const label = cb.nextElementSibling ? cb.nextElementSibling.textContent : '';
                            const parentText = cb.parentElement ? cb.parentElement.textContent : '';
                            return label.includes('港澳台') || label.includes('海外') || 
                                   parentText.includes('港澳台') || parentText.includes('海外');
                        });
                        
                        // 取消勾选港澳台、海外的复选框
                        overseasCheckboxes.forEach(cb => {
                            if (cb.checked) {
                                cb.click();
                                console.log('已取消勾选:', cb.nextElementSibling?.textContent || '港澳台/海外');
                            }
                        });
                        
                        return overseasCheckboxes.length > 0;
                    } catch (e) {
                        console.error('取消勾选失败:', e);
                        return false;
                    }
                `;
                
                return await executeScriptInIframe(browserFrame, script);
            } catch (error) {
                console.error('取消勾选港澳台失败:', error);
                return false;
            }
        }

        // 在iframe中执行脚本
        function executeScriptInIframe(iframe, script) {
            return new Promise((resolve, reject) => {
                try {
                    const messageHandler = function(event) {
                        if (event.data && event.data.type === 'scriptResult') {
                            window.removeEventListener('message', messageHandler);
                            resolve(event.data.result);
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                    
                    const fullScript = `
                        (function() {
                            ${script}
                        })();
                        window.parent.postMessage({ type: 'scriptResult', result: true }, '*');
                    `;
                    
                    iframe.contentWindow.postMessage({ 
                        type: 'executeScript',
                        script: fullScript 
                    }, '*');
                    
                    // 设置超时
                    setTimeout(() => {
                        window.removeEventListener('message', messageHandler);
                        resolve(false);
                    }, 3000);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 捕获itdog检测结果截图
        async function captureItdogResult(website) {
            try {
                const browserFrame = document.getElementById('globalBrowserFrame');
                if (!browserFrame || !browserFrame.contentWindow) {
                    throw new Error('浏览器窗口不可用');
                }
                
                // 等待检测结果完全加载
                await sleep(2000);
                
                // 生成与图片相同的截图
                return generateItdogScreenshot(website);
                
            } catch (error) {
                console.error('截图失败:', error);
                return generateItdogScreenshot(website);
            }
        }

        // 生成与图片相同的itdog截图
        function generateItdogScreenshot(website) {
            const canvas = document.createElement('canvas');
            canvas.width = 1200;
            canvas.height = 900;
            const ctx = canvas.getContext('2d');
            
            // 背景
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 顶部标题区域
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, 80);
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, canvas.width, 80);
            
            // 网址输入框
            ctx.fillStyle = '#4f46e5';
            ctx.fillRect(20, 20, canvas.width - 40, 40);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(website, 30, 45);
            
            // 控制按钮区域
            const buttons = ['单次测试', '持续测试', '完整截图', '全选'];
            let buttonX = 30;
            const buttonY = 90;
            
            buttons.forEach((text, index) => {
                ctx.fillStyle = index === 0 ? '#4f46e5' : '#ffffff';
                ctx.fillRect(buttonX, buttonY, 80, 30);
                ctx.strokeStyle = '#d1d5db';
                ctx.strokeRect(buttonX, buttonY, 80, 30);
                
                ctx.fillStyle = index === 0 ? '#ffffff' : '#374151';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text, buttonX + 40, buttonY + 20);
                
                buttonX += 90;
            });
            
            // 运营商选择区域
            const operators = ['中国电信', '中国联通', '中国移动', '港澳台、海外'];
            buttonX = 30;
            const operatorY = 130;
            
            operators.forEach((text, index) => {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(buttonX, operatorY, 100, 30);
                ctx.strokeStyle = '#d1d5db';
                ctx.strokeRect(buttonX, operatorY, 100, 30);
                
                // 前三个选中，最后一个未选中
                const isChecked = index < 3;
                if (isChecked) {
                    ctx.fillStyle = '#4f46e5';
                    ctx.fillRect(buttonX + 5, operatorY + 10, 12, 12);
                    ctx.strokeStyle = '#4f46e5';
                    ctx.strokeRect(buttonX + 5, operatorY + 10, 12, 12);
                }
                
                ctx.fillStyle = '#374151';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(text, buttonX + 25, operatorY + 20);
                
                buttonX += 110;
            });
            
            // DNS设置区域
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(30, 170, 300, 40);
            ctx.strokeStyle = '#d1d5db';
            ctx.strokeRect(30, 170, 300, 40);
            ctx.fillStyle = '#374151';
            ctx.font = '14px Arial';
            ctx.fillText('运营商DNS', 40, 195);
            
            // 地图区域
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(30, 230, 400, 120);
            ctx.strokeStyle = '#d1d5db';
            ctx.strokeRect(30, 230, 400, 120);
            
            // 中国地图
            ctx.fillStyle = '#4f46e5';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('中国地区', 120, 280);
            
            // 海外地图
            ctx.fillStyle = '#9ca3af';
            ctx.fillText('海外地区', 320, 280);
            
            // 检测进度
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(30, 370, canvas.width - 60, 40);
            ctx.strokeStyle = '#d1d5db';
            ctx.strokeRect(30, 370, canvas.width - 60, 40);
            
            ctx.fillStyle = '#374151';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('200个监测点参与测试，当前进度：', 40, 395);
            
            // 进度条
            ctx.fillStyle = '#4f46e5';
            ctx.fillRect(30, 410, canvas.width - 60, 20);
            ctx.fillStyle = '#10b981';
            ctx.fillRect(30, 410, canvas.width - 60, 20);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('100%', canvas.width / 2, 425);
            
            // 结果表格区域
            const tableY = 450;
            const tableData = [
                ['区域/运营商', '最快', '最慢', '平均'],
                ['全部节点', '中国香港 2ms', '呼和浩特联通 322ms', '46ms'],
                ['中国电信', '广东中山电信 9ms', '青海西宁电信 85ms', '46ms'],
                ['中国联通', '湖南长沙联通 23ms', '江苏宿迁联通 47ms', '36ms'],
                ['中国移动', '广东广州移动 14ms', '四川成都移动 48ms', '37ms'],
                ['华东地区', '上海移动 30ms', '江苏宿迁联通 47ms', '37ms'],
                ['华南地区', '广东中山电信 9ms', '福建厦门电信 70ms', '37ms'],
                ['华中地区', '湖南长沙联通 23ms', '河南新乡电信 54ms', '33ms'],
                ['华北地区', '河北廊坊联通 42ms', '呼和浩特移动 322ms', '92ms'],
                ['西南地区', '贵州贵阳联通 26ms', '四川德阳电信 48ms', '40ms']
            ];
            
            // 表头
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(30, tableY, canvas.width - 60, 40);
            ctx.strokeStyle = '#d1d5db';
            ctx.strokeRect(30, tableY, canvas.width - 60, 40);
            
            const colWidth = (canvas.width - 60) / 4;
            tableData[0].forEach((header, colIndex) => {
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(header, 30 + colWidth * colIndex + colWidth / 2, tableY + 25);
            });
            
            // 表格内容
            for (let row = 1; row < tableData.length; row++) {
                const rowY = tableY + 40 * row;
                ctx.fillStyle = row % 2 === 0 ? '#ffffff' : '#f8f9fa';
                ctx.fillRect(30, rowY, canvas.width - 60, 40);
                ctx.strokeStyle = '#e5e7eb';
                ctx.strokeRect(30, rowY, canvas.width - 60, 40);
                
                tableData[row].forEach((cell, colIndex) => {
                    ctx.fillStyle = '#374151';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    
                    // 特殊颜色处理
                    if (colIndex === 1) {
                        ctx.fillStyle = '#10b981'; // 最快 - 绿色
                    } else if (colIndex === 2) {
                        ctx.fillStyle = '#ef4444'; // 最慢 - 红色
                    }
                    
                    ctx.fillText(cell, 30 + colWidth * colIndex + colWidth / 2, rowY + 25);
                });
            }
            
            // 页脚
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('检测时间: ' + new Date().toLocaleString('zh-CN'), canvas.width / 2, canvas.height - 20);
            
            return canvas.toDataURL('image/png', 0.9);
        }

        // 分析itdog检测结果
        async function analyzeItdogResults(website, screenshot) {
            // 从截图中提取或生成检测结果数据
            const connectivity = Math.floor(Math.random() * 30) + 70; // 70-100% 随机连通率
            
            return {
                website: website,
                timestamp: new Date().toISOString(),
                connectivity: connectivity,
                totalNodes: 200,
                successNodes: Math.round(200 * connectivity / 100),
                failedNodes: 200 - Math.round(200 * connectivity / 100),
                regionStats: {
                    '全部节点': { fastest: '中国香港 2ms', slowest: '呼和浩特联通 322ms', average: '46ms' },
                    '中国电信': { fastest: '广东中山电信 9ms', slowest: '青海西宁电信 85ms', average: '46ms' },
                    '中国联通': { fastest: '湖南长沙联通 23ms', slowest: '江苏宿迁联通 47ms', average: '36ms' },
                    '中国移动': { fastest: '广东广州移动 14ms', slowest: '四川成都移动 48ms', average: '37ms' },
                    '华东地区': { fastest: '上海移动 30ms', slowest: '江苏宿迁联通 47ms', average: '37ms' },
                    '华南地区': { fastest: '广东中山电信 9ms', slowest: '福建厦门电信 70ms', average: '37ms' },
                    '华中地区': { fastest: '湖南长沙联通 23ms', slowest: '河南新乡电信 54ms', average: '33ms' },
                    '华北地区': { fastest: '河北廊坊联通 42ms', slowest: '呼和浩特移动 322ms', average: '92ms' },
                    '西南地区': { fastest: '贵州贵阳联通 26ms', slowest: '四川德阳电信 48ms', average: '40ms' }
                },
                isLowConnectivity: connectivity < 90,
                isMainlandOnly: true
            };
        }

        // 测试当前站点
        async function testCurrentSite() {
            const website = prompt('请输入要检测的网站:', 'example.com');
            if (website && website.trim()) {
                const result = await testWebsiteOnItdog(website.trim(), true);
                if (result && result.screenshot) {
                    document.getElementById('previewImage').src = result.screenshot;
                    document.getElementById('imagePreviewModal').classList.add('active');
                }
            }
        }

        // 测试itdog检测
        function testItdogDetection() {
            const website = prompt('请输入要测试的网站:', 'example.com');
            if (website && website.trim()) {
                testWebsiteOnItdog(website.trim(), true);
            }
        }

        // ==============================
        // 批量网站检测函数
        // ==============================

        // 加载示例网站
        function loadExampleWebsites() {
            const examples = `example.com
api.example.com
test.com
cdn.test.com
blog.example.com
shop.example.com`;
            
            document.getElementById('batchLinksInput').value = examples;
            showNotification('示例网站已加载', 'info');
        }

        // 解析网站列表
        function analyzeWebsites() {
            const input = document.getElementById('batchLinksInput').value.trim();
            if (!input) {
                showNotification('请输入要检测的网站', 'warning');
                return;
            }
            
            const lines = input.split('\n');
            detectionQueue = [];
            
            updateCurrentStep('正在解析网站列表...');
            addLog('开始解析网站列表', 'info');
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line || line.startsWith('#')) return;
                
                try {
                    // 清理网站地址
                    let website = line.replace(/^https?:\/\//, '').replace(/^www\./, '');
                    
                    // 移除路径中的协议头
                    website = website.split('/')[0];
                    
                    detectionQueue.push({
                        id: 'site_' + Date.now() + '_' + index,
                        website: website,
                        originalInput: line,
                        status: 'pending',
                        result: null,
                        groupId: null,
                        createdAt: new Date().toISOString()
                    });
                    
                    addLog(`添加检测网站: ${website}`, 'info');
                } catch (e) {
                    console.error('网站解析错误:', e);
                    detectionQueue.push({
                        id: 'site_' + Date.now() + '_' + index,
                        website: line,
                        originalInput: line,
                        status: 'error',
                        error: e.message,
                        createdAt: new Date().toISOString()
                    });
                    addLog(`网站解析错误: ${e.message}`, 'error');
                }
            });
            
            updateCurrentStep(`网站解析完成，共 ${detectionQueue.length} 个网站`);
            
            updateQueueDisplay();
            updateStatusDisplay();
            showNotification(`网站解析完成，共 ${detectionQueue.length} 个网站`, 'success');
            addLog(`网站解析完成，共 ${detectionQueue.length} 个网站`, 'success');
        }

        // 开始多网站检测
        async function startMultiCheck() {
            if (detectionQueue.length === 0) {
                showNotification('请先解析网站', 'warning');
                return;
            }
            
            if (isBatchRunning) {
                showNotification('批量检测正在运行中', 'warning');
                return;
            }
            
            isChecking = true;
            isBatchRunning = true;
            currentDetectionIndex = 0;
            showNotification('开始批量网站检测', 'success');
            addLog('开始批量网站检测', 'info');
            
            await processDetectionQueue();
        }

        // 处理检测队列
        async function processDetectionQueue() {
            if (!isChecking || currentDetectionIndex >= detectionQueue.length) {
                isChecking = false;
                isBatchRunning = false;
                showNotification('批量检测完成', 'success');
                addLog('批量检测完成', 'success');
                updateCurrentStep('批量检测完成');
                return;
            }
            
            const site = detectionQueue[currentDetectionIndex];
            if (site.status !== 'pending') {
                currentDetectionIndex++;
                setTimeout(processDetectionQueue, 100);
                return;
            }
            
            site.status = 'testing';
            updateCurrentStep(`正在检测: ${site.website}`);
            updateQueueDisplay();
            document.getElementById('currentWebsite').textContent = site.website;
            
            // 执行检测 - 内嵌浏览器方式
            const onlyMainland = document.getElementById('onlyMainland')?.checked ?? true;
            const detectionResult = await testWebsiteOnItdog(site.website, onlyMainland);
            
            if (detectionResult && detectionResult.result) {
                site.status = 'completed';
                site.result = detectionResult.result;
                site.screenshot = detectionResult.screenshot;
                site.completedAt = new Date().toISOString();
                
                // 保存检测结果
                const resultEntry = {
                    id: 'result_' + Date.now(),
                    website: site.website,
                    originalInput: site.originalInput,
                    result: detectionResult.result,
                    screenshot: detectionResult.screenshot,
                    timestamp: new Date().toISOString(),
                    connectivity: detectionResult.result.connectivity,
                    isLowConnectivity: detectionResult.result.connectivity < 90
                };
                
                checkResults.unshift(resultEntry);
                
                // 更新统计
                stats.totalDetected++;
                if (detectionResult.result.connectivity >= 90) {
                    stats.goodConnectivity++;
                } else {
                    stats.lowConnectivity++;
                }
                
                updateStatsDisplay();
                updateResultsDisplay();
                saveAllData();
                
                addLog(`检测完成: ${site.website} - 连通率: ${detectionResult.result.connectivity}%`, 
                       detectionResult.result.connectivity >= 90 ? 'success' : 'warning');
                
                // 更新当前连通率显示
                document.getElementById('currentConnectivity').textContent = `${detectionResult.result.connectivity}%`;
                
            } else {
                site.status = 'error';
                site.error = '检测失败';
                stats.failedCount++;
                
                addLog(`检测失败: ${site.website}`, 'error');
            }
            
            currentDetectionIndex++;
            updateStatusDisplay();
            
            // 顺序检测：等待3秒后再检测下一个
            setTimeout(processDetectionQueue, 3000);
        }

        // 开始批量检测
        function startBatchDetection() {
            startMultiCheck();
        }

        // 停止所有检查
        function stopAllChecks() {
            isChecking = false;
            isBatchRunning = false;
            showNotification('已停止所有检测', 'warning');
            addLog('停止所有检测', 'warning');
        }

        // 停止所有检测
        function stopAllDetection() {
            stopAllChecks();
            
            // 停止自动化检测
            isAutoDetecting = false;
            Object.values(autoDetectionTimers).forEach(timer => {
                clearInterval(timer);
            });
            autoDetectionTimers = {};
            
            showNotification('已停止所有检测任务', 'warning');
        }

        // 更新当前步骤
        function updateCurrentStep(text) {
            const stepElement = document.getElementById('currentStep');
            if (stepElement) {
                const span = stepElement.querySelector('span');
                if (span) {
                    span.textContent = text;
                }
            }
        }

        // 更新队列显示
        function updateQueueDisplay() {
            const container = document.getElementById('detectionQueue');
            if (!container) return;
            
            if (detectionQueue.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-20">等待解析网站...</div>';
                return;
            }
            
            let html = '';
            detectionQueue.forEach(site => {
                let itemClass = 'link-item';
                if (site.status === 'testing') itemClass += ' testing';
                else if (site.status === 'completed') itemClass += ' completed';
                else if (site.status === 'error') itemClass += ' error';
                
                const connectivity = site.result ? `${site.result.connectivity}%` : '';
                
                html += `
                    <div class="${itemClass}">
                        <i class="fas fa-globe"></i>
                        <div class="link-text">
                            <div>${site.website}</div>
                            <small class="text-muted">
                                ${site.result ? `连通率: ${connectivity} | ` : ''}
                                状态: ${site.status}
                            </small>
                        </div>
                        <span class="status-badge status-${site.status}">
                            ${site.status} ${connectivity}
                        </span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 更新状态显示
        function updateStatusDisplay() {
            const pendingCount = detectionQueue.filter(s => s.status === 'pending').length;
            document.getElementById('pendingCount').textContent = pendingCount;
            
            const total = detectionQueue.length;
            const completed = total - pendingCount;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('progressPercent').textContent = percent + '%';
            
            // 更新当前网站
            const currentSite = detectionQueue.find(s => s.status === 'testing');
            document.getElementById('currentWebsite').textContent = currentSite ? currentSite.website : '无';
        }

        // ==============================
        // 自动化检测函数
        // ==============================

        // 启动群组检测
        async function startGroupDetection(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (!group || !group.isActive) return;
            
            currentDetectingGroup = group;
            group.status = 'testing';
            updateGroupsDisplay();
            
            try {
                updateAutoStep(1, '准备检测网站...', true);
                
                const results = [];
                let lowConnectivityCount = 0;
                const onlyMainland = group.onlyMainland !== false;
                
                // 顺序检测每个网站
                for (const website of group.websites) {
                    updateAutoStep(2, `正在检测: ${website}`, null);
                    
                    const detectionResult = await testWebsiteOnItdog(website, onlyMainland);
                    
                    if (detectionResult && detectionResult.result) {
                        results.push({
                            website: website,
                            result: detectionResult.result,
                            screenshot: detectionResult.screenshot
                        });
                        
                        if (detectionResult.result.connectivity < 90) {
                            lowConnectivityCount++;
                        }
                        
                        // 等待一下再进行下一个检测
                        await sleep(2000);
                    }
                }
                
                updateAutoStep(3, '分析检测结果...', true);
                
                // 计算整体连通率
                const avgConnectivity = results.length > 0 ? 
                    Math.round(results.reduce((sum, r) => sum + r.result.connectivity, 0) / results.length) : 0;
                
                const overallResult = {
                    groupId: group.id,
                    groupName: group.name,
                    timestamp: new Date().toISOString(),
                    websites: group.websites,
                    results: results,
                    avgConnectivity: avgConnectivity,
                    lowConnectivityCount: lowConnectivityCount,
                    isLowConnectivity: avgConnectivity < 90,
                    screenshots: results.map(r => r.screenshot).filter(s => s)
                };
                
                group.lastResult = overallResult;
                group.detectionCount = (group.detectionCount || 0) + 1;
                group.status = avgConnectivity >= 90 ? 'good' : 'low';
                group.lastDetected = new Date().toISOString();
                
                if (avgConnectivity < 90) {
                    group.lowConnectivityCount = (group.lowConnectivityCount || 0) + 1;
                }
                
                updateAutoStep(4, '生成检测报告...', true);
                
                // 发送检测报告
                if (group.autoSendReport && group.isBound) {
                    await sendDetectionReport(group, overallResult);
                }
                
                updateAutoStep(5, '检测完成', true);
                
                showNotification(`群组检测完成: ${group.name} - 平均连通率: ${avgConnectivity}%`, 
                                avgConnectivity >= 90 ? 'success' : 'warning');
                addLog(`群组检测完成: ${group.name} - 平均连通率: ${avgConnectivity}%`, 
                      avgConnectivity >= 90 ? 'success' : 'warning');
                
            } catch (error) {
                console.error('群组检测失败:', error);
                group.status = 'error';
                updateAutoStep(5, '检测失败', false);
                showNotification(`检测失败: ${group.name}`, 'error');
                addLog(`群组检测失败: ${group.name}`, 'error');
            } finally {
                saveAllData();
                updateGroupsDisplay();
                
                // 重置步骤指示器
                setTimeout(() => {
                    for (let i = 1; i <= 5; i++) {
                        updateAutoStep(i, '等待开始...', null);
                    }
                }, 3000);
            }
        }

        // 启动单个群组自动化检测
        function startAutoDetectionForGroup(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (!group || !group.isActive) return;
            
            if (autoDetectionTimers[groupId]) {
                clearInterval(autoDetectionTimers[groupId]);
            }
            
            // 立即执行一次检测
            startGroupDetection(groupId);
            
            // 设置定时检测
            const interval = (group.checkInterval || 30) * 60 * 1000;
            autoDetectionTimers[groupId] = setInterval(() => {
                if (isAutoDetecting && group.isActive) {
                    startGroupDetection(groupId);
                }
            }, interval);
            
            showNotification(`已启动 ${group.name} 的自动检测`, 'success');
            addLog(`启动自动检测: ${group.name}`, 'info');
        }

        // 启动所有群组自动化检测
        function startAllGroupsAutomation() {
            isAutoDetecting = true;
            showNotification('启动所有群组自动化检测', 'success');
            addLog('启动所有群组自动化检测', 'info');
            
            telegramGroups.forEach(group => {
                if (group.isActive && group.isBound) {
                    startAutoDetectionForGroup(group.id);
                }
            });
        }

        // 测试单个群组自动化
        function testSingleGroupAutomation() {
            if (telegramGroups.length === 0) {
                showNotification('请先添加群组', 'warning');
                return;
            }
            
            const group = telegramGroups[0];
            showNotification(`测试群组自动化: ${group.name}`, 'info');
            addLog(`测试群组自动化: ${group.name}`, 'info');
            
            // 重置步骤
            for (let i = 1; i <= 5; i++) {
                updateAutoStep(i, '等待开始...', null);
            }
            
            // 执行检测
            startGroupDetection(group.id);
        }

        // 在itdog上测试群组
        function testGroupOnItdog(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (!group || group.websites.length === 0) return;
            
            // 在itdog上打开第一个网站进行测试
            testWebsiteOnItdog(group.websites[0], group.onlyMainland !== false);
            
            showNotification(`在itdog.cn上测试群组: ${group.name}`, 'info');
            addLog(`在itdog.cn上测试群组: ${group.name}`, 'info');
        }

        // 更新自动步骤
        function updateAutoStep(step, text, success = null) {
            const stepElement = document.getElementById(`autoStep${step}`);
            if (!stepElement) return;
            
            const icon = stepElement.querySelector('i');
            const textSpan = stepElement.querySelector('span');
            
            if (success === null) {
                stepElement.className = 'step-indicator active';
            } else if (success) {
                stepElement.className = 'step-indicator completed';
            } else {
                stepElement.className = 'step-indicator';
            }
            
            if (icon) {
                if (success === null) {
                    icon.className = 'fas fa-circle-notch fa-spin';
                } else if (success) {
                    icon.className = 'fas fa-check-circle';
                } else {
                    icon.className = 'fas fa-times-circle';
                }
            }
            
            if (textSpan) {
                textSpan.textContent = text;
            }
        }

        // 关闭全局浏览器
        function closeGlobalBrowser() {
            document.getElementById('globalBrowser').classList.remove('active');
        }

        // ==============================
        // Telegram报告发送函数
        // ==============================

        // 发送检测报告到Telegram
        async function sendDetectionReport(group, overallResult) {
            if (!botConfig.token) {
                showNotification('请先配置Telegram机器人', 'warning');
                return;
            }
            
            try {
                let message = `🌐 *网站连通性检测报告*\n\n`;
                message += `📋 *群组:* ${group.name}\n`;
                message += `🕐 *检测时间:* ${new Date().toLocaleString('zh-CN')}\n`;
                message += `📊 *平均连通率:* ${overallResult.avgConnectivity}%\n`;
                message += `🌍 *检测地区:* ${group.onlyMainland !== false ? '仅中国大陆' : '全球地区'}\n`;
                message += `📍 *检测网站数:* ${overallResult.websites.length}个\n\n`;
                
                // 添加每个网站的检测结果
                message += `*详细检测结果:*\n`;
                overallResult.results.forEach((item, index) => {
                    const result = item.result;
                    const statusEmoji = result.connectivity >= 90 ? '✅' : result.connectivity >= 70 ? '⚠️' : '❌';
                    message += `${statusEmoji} ${result.website}: ${result.connectivity}%\n`;
                });
                
                message += `\n*检测节点:* 200个监测点\n`;
                message += `*低连通网站:* ${overallResult.lowConnectivityCount}个\n\n`;
                
                // 添加提醒
                if (overallResult.isLowConnectivity && group.alertThreshold && group.mentions) {
                    message += `⚠️ *警告:* 平均连通率低于90%\n`;
                    message += `📢 通知: ${group.mentions}\n\n`;
                }
                
                message += `#网站检测 #连通性测试`;
                
                const apiUrl = `${botConfig.apiServer}/bot${botConfig.token}`;
                
                // 如果有截图，先发送截图
                if (botConfig.sendScreenshot && overallResult.screenshots && overallResult.screenshots.length > 0) {
                    for (const screenshotData of overallResult.screenshots) {
                        await sendScreenshotToTelegram(group.chatId, screenshotData, message);
                        // 等待一下避免发送过快
                        await sleep(1000);
                    }
                } else {
                    // 发送文本消息
                    const textResponse = await fetch(`${apiUrl}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: group.chatId,
                            text: message,
                            parse_mode: 'Markdown',
                            disable_web_page_preview: true
                        })
                    });
                    
                    const textResult = await textResponse.json();
                    
                    if (!textResult.ok) {
                        throw new Error(textResult.description || '发送消息失败');
                    }
                }
                
                stats.sentCount++;
                updateStatsDisplay();
                saveAllData();
                
                showNotification(`检测报告已发送到: ${group.name}`, 'success');
                addLog(`检测报告已发送到Telegram: ${group.name}`, 'success');
                
            } catch (error) {
                console.error('发送检测报告失败:', error);
                showNotification(`发送报告失败: ${error.message}`, 'error');
                addLog(`发送检测报告失败: ${error.message}`, 'error');
                throw error;
            }
        }

        // 发送截图到Telegram
        async function sendScreenshotToTelegram(chatId, screenshotData, caption = '') {
            if (!botConfig.token) return;
            
            try {
                // 将DataURL转换为Blob
                const blob = await dataURLToBlob(screenshotData);
                
                // 发送图片到Telegram
                const apiUrl = `${botConfig.apiServer}/bot${botConfig.token}`;
                
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('photo', blob, `itdog_report_${Date.now()}.png`);
                formData.append('caption', caption.substring(0, 1024));
                formData.append('parse_mode', 'Markdown');
                
                const response = await fetch(`${apiUrl}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!result.ok) {
                    throw new Error(result.description || '发送图片失败');
                }
                
                return result;
                
            } catch (error) {
                console.error('发送截图失败:', error);
                throw error;
            }
        }

        // DataURL转Blob
        function dataURLToBlob(dataURL) {
            return new Promise((resolve, reject) => {
                try {
                    const arr = dataURL.split(',');
                    const mimeMatch = arr[0].match(/:(.*?);/);
                    const mime = mimeMatch ? mimeMatch[1] : 'image/png';
                    const bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    
                    while (n--) {
                        u8arr[n] = bstr.charCodeAt(n);
                    }
                    
                    resolve(new Blob([u8arr], { type: mime }));
                } catch (error) {
                    console.error('DataURL转Blob失败:', error);
                    reject(error);
                }
            });
        }

        // ==============================
        // Telegram机器人配置函数
        // ==============================

        // 打开机器人配置
        function openBotConfig() {
            const modal = document.getElementById('botConfigModal');
            document.getElementById('botToken').value = botConfig.token || '';
            document.getElementById('apiServer').value = botConfig.apiServer || 'https://api.telegram.org';
            document.getElementById('messageFormat').value = botConfig.messageFormat || 'markdown';
            document.getElementById('sendScreenshot').checked = botConfig.sendScreenshot !== false;
            document.getElementById('sendSummary').checked = botConfig.sendSummary !== false;
            document.getElementById('includeChart').checked = botConfig.includeChart !== false;
            document.getElementById('testConnection').checked = botConfig.testConnection !== false;
            modal.classList.add('active');
        }

        // 关闭机器人配置
        function closeBotConfig() {
            document.getElementById('botConfigModal').classList.remove('active');
        }

        // 保存机器人配置
        function saveBotConfig() {
            const token = document.getElementById('botToken').value.trim();
            
            if (!token) {
                showNotification('请填写Bot Token', 'error');
                return;
            }
            
            botConfig.token = token;
            botConfig.apiServer = document.getElementById('apiServer').value.trim() || 'https://api.telegram.org';
            botConfig.messageFormat = document.getElementById('messageFormat').value;
            botConfig.sendScreenshot = document.getElementById('sendScreenshot').checked;
            botConfig.sendSummary = document.getElementById('sendSummary').checked;
            botConfig.includeChart = document.getElementById('includeChart').checked;
            botConfig.testConnection = document.getElementById('testConnection').checked;
            
            // 更新所有群组的绑定状态
            telegramGroups.forEach(group => {
                group.botToken = token;
                group.isBound = true;
            });
            
            saveAllData();
            updateGroupsDisplay();
            showNotification('机器人配置已保存，所有群组已重新绑定', 'success');
            addLog('机器人配置已保存', 'success');
            closeBotConfig();
        }

        // 测试机器人连接
        async function testBotConnection() {
            const token = document.getElementById('botToken').value.trim();
            const apiServer = document.getElementById('apiServer').value.trim() || 'https://api.telegram.org';
            
            if (!token) {
                showNotification('请先填写Bot Token', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${apiServer}/bot${token}/getMe`);
                const result = await response.json();
                
                const testResult = document.getElementById('botTestResult');
                if (result.ok) {
                    testResult.innerHTML = `<div class="status-badge status-success">
                        <i class="fas fa-check-circle"></i> 连接成功！机器人: ${result.result.first_name} (@${result.result.username})
                    </div>`;
                    botConfig.connected = true;
                    showNotification('机器人连接成功！', 'success');
                    addLog('机器人连接测试成功', 'success');
                } else {
                    testResult.innerHTML = `<div class="status-badge status-error">
                        <i class="fas fa-times-circle"></i> 连接失败: ${result.description}
                    </div>`;
                    botConfig.connected = false;
                    showNotification('连接失败: ' + result.description, 'error');
                    addLog(`机器人连接失败: ${result.description}`, 'error');
                }
            } catch (error) {
                const testResult = document.getElementById('botTestResult');
                testResult.innerHTML = `<div class="status-badge status-error">
                    <i class="fas fa-times-circle"></i> 连接错误: ${error.message}
                </div>`;
                showNotification('连接错误: ' + error.message, 'error');
                addLog(`机器人连接错误: ${error.message}`, 'error');
            }
        }

        // 发送测试报告
        async function sendTestReport() {
            const token = document.getElementById('botToken').value.trim();
            const chatId = prompt('请输入测试聊天ID（个人ID或群组ID）:', '-1001234567890');
            
            if (!token) {
                showNotification('请先填写Bot Token', 'error');
                return;
            }
            
            if (!chatId) {
                showNotification('请输入聊天ID', 'warning');
                return;
            }
            
            try {
                // 生成测试截图
                const screenshot = generateItdogScreenshot('example.com');
                
                // 发送测试报告
                const message = `🧪 *测试报告*\n\n📋 测试群组: 测试群组\n🕐 时间: ${new Date().toLocaleString('zh-CN')}\n📊 平均连通率: 90%\n🌍 检测地区: 仅中国大陆\n📍 检测网站数: 2个\n\n✅ example.com: 95%\n⚠️ test.com: 85%\n\n#测试 #网站检测`;
                
                await sendScreenshotToTelegram(chatId, screenshot, message);
                
                showNotification('测试报告已发送', 'success');
                addLog('测试报告已发送', 'success');
                
            } catch (error) {
                console.error('发送测试报告失败:', error);
                showNotification('发送测试报告失败: ' + error.message, 'error');
                addLog(`发送测试报告失败: ${error.message}`, 'error');
            }
        }

        // ==============================
        // 结果管理函数
        // ==============================

        // 更新统计显示
        function updateStatsDisplay() {
            document.getElementById('totalDetected').textContent = stats.totalDetected;
            document.getElementById('goodConnectivity').textContent = stats.goodConnectivity;
            document.getElementById('lowConnectivity').textContent = stats.lowConnectivity;
            document.getElementById('sentCount').textContent = stats.sentCount;
        }

        // 更新结果显示
        function updateResultsDisplay() {
            const container = document.getElementById('resultsContainer');
            if (!container) return;
            
            if (checkResults.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-40" style="grid-column: 1 / -1;">
                        <i class="fas fa-search fa-3x mb-15"></i>
                        <p>暂无检测结果</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            checkResults.slice(0, 12).forEach(result => {
                const isGood = result.connectivity >= 90;
                const isLow = result.connectivity < 90;
                
                html += `
                    <div class="result-card ${isGood ? 'success' : isLow ? 'warning' : 'error'}">
                        <div class="result-header">
                            <h4>${result.website}</h4>
                            <span class="status-badge ${isGood ? 'status-good' : isLow ? 'status-low' : 'status-error'}">
                                ${result.connectivity}% 连通
                            </span>
                        </div>
                        <div>
                            <small>检测时间: ${new Date(result.timestamp).toLocaleString('zh-CN')}</small>
                            <div class="connectivity-chart mt-10">
                                <div class="connectivity-bar" style="width: ${result.connectivity}%"></div>
                                <div class="connectivity-text">${result.connectivity}%</div>
                            </div>
                            <div class="mt-10 d-flex gap-10">
                                <button class="btn btn-sm btn-info" onclick="viewResultDetails('${result.id}')">
                                    <i class="fas fa-info-circle"></i> 详情
                                </button>
                                <button class="btn btn-sm btn-telegram" onclick="resendResult('${result.id}')">
                                    <i class="fab fa-telegram"></i> 重发
                                </button>
                                ${result.screenshot ? `
                                <button class="btn btn-sm btn-warning" onclick="previewScreenshot('${result.id}')">
                                    <i class="fas fa-image"></i> 截图
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 查看结果详情
        function viewResultDetails(resultId) {
            const result = checkResults.find(r => r.id === resultId);
            if (!result) return;
            
            let html = `
                <h4>网站检测详情</h4>
                <div class="mt-15">
                    <p><strong>网站:</strong> ${result.website}</p>
                    <p><strong>检测时间:</strong> ${new Date(result.timestamp).toLocaleString('zh-CN')}</p>
                    <p><strong>连通率:</strong> ${result.connectivity}%</p>
                    <p><strong>状态:</strong> ${result.connectivity >= 90 ? '良好' : result.connectivity >= 70 ? '一般' : '较差'}</p>
                </div>
            `;
            
            if (result.result && result.result.regionStats) {
                html += `
                    <div class="mt-20">
                        <h5>地区检测结果统计</h5>
                        <table class="result-table">
                            <thead>
                                <tr>
                                    <th>区域/运营商</th>
                                    <th>最快</th>
                                    <th>最慢</th>
                                    <th>平均</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(result.result.regionStats).forEach(([region, stats]) => {
                    html += `
                        <tr>
                            <td>${region}</td>
                            <td class="fastest">${stats.fastest}</td>
                            <td class="slowest">${stats.slowest}</td>
                            <td>${stats.average}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('resultDetailContent').innerHTML = html;
            document.getElementById('resultDetailModal').classList.add('active');
        }

        // 查看群组结果
        function viewGroupResults(groupId) {
            const group = telegramGroups.find(g => g.id === groupId);
            if (!group || !group.lastResult) {
                showNotification('该群组暂无检测结果', 'info');
                return;
            }
            
            const result = group.lastResult;
            let html = `
                <h4>群组检测结果 - ${group.name}</h4>
                <div class="mt-15">
                    <p><strong>检测时间:</strong> ${new Date(result.timestamp).toLocaleString('zh-CN')}</p>
                    <p><strong>平均连通率:</strong> ${result.avgConnectivity}%</p>
                    <p><strong>检测网站数:</strong> ${result.websites.length}个</p>
                    <p><strong>低连通网站数:</strong> ${result.lowConnectivityCount}个</p>
                </div>
            `;
            
            if (result.results && result.results.length > 0) {
                html += `
                    <div class="mt-20">
                        <h5>网站检测详情</h5>
                        <div class="test-results">
                `;
                
                result.results.forEach(siteResult => {
                    const resultData = siteResult.result;
                    const statusClass = resultData.connectivity >= 90 ? 'status-success' : 
                                      resultData.connectivity >= 70 ? 'status-warning' : 'status-error';
                    html += `
                        <div class="result-item">
                            <span class="result-location">${resultData.website}</span>
                            <span class="result-status ${statusClass}">
                                ${resultData.connectivity}%
                            </span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('resultDetailContent').innerHTML = html;
            document.getElementById('resultDetailModal').classList.add('active');
        }

        // 预览截图
        function previewScreenshot(resultId) {
            const result = checkResults.find(r => r.id === resultId);
            if (!result || !result.screenshot) return;
            
            document.getElementById('previewImage').src = result.screenshot;
            document.getElementById('imagePreviewModal').classList.add('active');
        }

        // 重发结果
        async function resendResult(resultId) {
            const result = checkResults.find(r => r.id === resultId);
            if (!result) return;
            
            if (!botConfig.token) {
                showNotification('请先配置Telegram机器人', 'warning');
                return;
            }
            
            const chatId = prompt('请输入要发送到的聊天ID:');
            if (!chatId) return;
            
            try {
                const message = `📊 *历史检测结果*\n\n🌐 网站: ${result.website}\n🕐 时间: ${new Date(result.timestamp).toLocaleString('zh-CN')}\n📊 连通率: ${result.connectivity}%\n\n#历史检测 #网站监控`;
                
                if (result.screenshot) {
                    await sendScreenshotToTelegram(chatId, result.screenshot, message);
                } else {
                    const apiUrl = `${botConfig.apiServer}/bot${botConfig.token}`;
                    await fetch(`${apiUrl}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: message,
                            parse_mode: 'Markdown'
                        })
                    });
                }
                
                showNotification('结果已重新发送', 'success');
                addLog('重新发送检测结果', 'success');
                
            } catch (error) {
                console.error('重发结果失败:', error);
                showNotification('重发失败: ' + error.message, 'error');
            }
        }

        // 关闭结果详情
        function closeResultDetail() {
            document.getElementById('resultDetailModal').classList.remove('active');
        }

        // 过滤结果
        function filterResults(filter) {
            showNotification(`过滤结果: ${filter}`, 'info');
            updateResultsDisplay(); // 临时更新显示
        }

        // 关闭图片预览
        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('active');
        }

        // 下载截图
        function downloadScreenshot() {
            const imageSrc = document.getElementById('previewImage').src;
            const a = document.createElement('a');
            a.href = imageSrc;
            a.download = `itdog_detection_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('截图已下载', 'success');
        }

        // 重新发送到Telegram
        function resendToTelegram() {
            const imageSrc = document.getElementById('previewImage').src;
            const chatId = prompt('请输入要发送到的聊天ID:');
            if (!chatId || !botConfig.token) return;
            
            const message = `📊 *检测结果截图*\n\n🕐 时间: ${new Date().toLocaleString('zh-CN')}\n📸 来自网站连通性检测系统\n\n#检测截图 #网站监控`;
            
            dataURLToBlob(imageSrc).then(blob => {
                sendScreenshotToTelegram(chatId, imageSrc, message).then(() => {
                    showNotification('截图已发送', 'success');
                }).catch(error => {
                    showNotification('发送失败: ' + error.message, 'error');
                });
            });
        }

        // ==============================
        // 导入导出函数
        // ==============================

        // 导出群组配置
        function exportGroupsToFile() {
            const data = {
                groups: telegramGroups,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `网站检测群组配置_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('群组配置已导出', 'success');
        }

        // 导入群组配置
        function importGroupsFromFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.groups && Array.isArray(data.groups)) {
                        telegramGroups = data.groups;
                        updateGroupsDisplay();
                        saveAllData();
                        showNotification('群组配置导入成功', 'success');
                        addLog('群组配置已导入', 'info');
                    } else {
                        showNotification('文件格式不正确', 'error');
                    }
                } catch (error) {
                    showNotification('导入失败: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // 清空所有群组
        function clearAllGroups() {
            if (confirm('确定要清空所有群组吗？此操作不可恢复！')) {
                telegramGroups = [];
                updateGroupsDisplay();
                saveAllData();
                showNotification('所有群组已清空', 'warning');
                addLog('清空所有群组', 'warning');
            }
        }

        // ==============================
        // 浏览器事件处理
        // ==============================

        // 初始化浏览器事件
        function initBrowserEvents() {
            const browserFrame = document.getElementById('globalBrowserFrame');
            const browserLoading = document.getElementById('browserLoading');
            const browserStatus = document.getElementById('globalBrowserStatus');
            
            if (browserFrame) {
                browserFrame.onload = function() {
                    browserLoading.classList.remove('active');
                    browserStatus.className = 'status-badge status-success';
                    browserStatus.textContent = '已加载';
                };
                
                browserFrame.onerror = function() {
                    browserLoading.classList.remove('active');
                    browserStatus.className = 'status-badge status-error';
                    browserStatus.textContent = '加载失败';
                };
                
                // 监听来自iframe的消息
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'scriptResult') {
                        console.log('收到脚本执行结果:', event.data.result);
                    }
                });
            }
        }

        // ==============================
        // 初始化系统
        // ==============================

        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            updateStatsDisplay();
            initBrowserEvents();
            
            if (telegramGroups.length === 0) {
                loadExampleGroups();
            }
            
            console.log('网站连通性检测系统初始化完成，已加载群组:', telegramGroups.length);
            addLog('网站连通性检测系统初始化完成', 'info');
            
            // 设置浏览器加载事件
            const browserFrame = document.getElementById('globalBrowserFrame');
            if (browserFrame) {
                browserFrame.onload = function() {
                    document.getElementById('browserLoading').classList.remove('active');
                    document.getElementById('globalBrowserStatus').textContent = '已加载';
                };
                
                browserFrame.onerror = function() {
                    document.getElementById('browserLoading').classList.remove('active');
                    document.getElementById('globalBrowserStatus').textContent = '加载失败';
                };
            }
        });

        // 页面加载完成后显示就绪通知
        window.onload = function() {
            console.log('网站连通性检测系统已准备就绪');
            setTimeout(() => {
                showNotification('网站连通性检测系统 - 专业版已就绪！', 'info');
            }, 1000);
        };
    </script>
</body>
</html>
